import{loadHeaderFooter as s,getLocalStorage as d}from"./utils.js";const h=/^\d{4}\s\d{4}\s\d{4}\s\d{4}$/,m=/^\d{3}$/,_=/^\(\d{3}\)\s\d{3}-\d{4}$/,u=["fname","lname","street","city","state","zip","phone","card-number","card-expiration","card-code"];function r(e,t,n="inline",c=""){var a=document.getElementById(e);a.innerHTML=t,a.style.display=n,c!=""&&document.getElementById(c).focus()}function i(e,t=!1){if(u.indexOf(e)!=-1){let n=document.getElementById("checkout__"+e);if(document.getElementById("checkout__"+e+"-error").style.display="none",n.value=="")return r("checkout__"+e+"-error","Required.","inline",t?"checkout__"+e:""),!1;switch(e){case"phone":return _.test(n.value)?!0:(r("checkout__"+e+"-error","10 digits are required.","inline",t?"checkout__"+e:""),!1);case"card-number":return h.test(n.value)?!0:(r("checkout__"+e+"-error","16 digits are required.","inline",t?"checkout__"+e:""),!1);case"card-code":return m.test(n.value)?!0:(r("checkout__"+e+"-error","3 digits are required.","inline",t?"checkout__"+e:""),!1);default:return!0}}else return!1}function o(e,t){var n=document.getElementById(e);if(n!=null)if(n.createTextRange){var c=n.createTextRange();c.move("character",t),c.select()}else n.selectionStart?(n.focus(),n.setSelectionRange(t,t)):n.focus()}function g(){var e=document.getElementById("checkout__phone"),t=e.value.replaceAll(/\D/g,""),n="";if(!t.length){e.value="";return}if(t.length>3)n+="("+t.substring(0,3)+") ",t=t.slice(3);else{e.value="("+t.padStart(3," ")+")    -    ",o("checkout__phone",4);return}if(t.length>3)n+=t.substring(0,3)+"-",t=t.slice(3);else{e.value=n+t.padStart(3," ")+"-    ",o("checkout__phone",9);return}if(t.length>4)e.value=n+t.substring(0,4);else{e.value=n+t.padStart(4," "),o("checkout__phone",14);return}}function p(){var e=document.getElementById("checkout__card-number").value.replaceAll(/\D/g,""),t="";if(!e.length){document.getElementById("checkout__card-number").value="";return}for(var n=0;n<4;n++)if(e.length>4)t+=e.substring(0,4)+(n==3?"":" "),e=e.slice(4);else{document.getElementById("checkout__card-number").value=t+e.padStart(4," "),o("checkout__card-number",(n+1)*5);return}document.getElementById("checkout__card-number").value=t.substring(0,19)}function E(){var e=document.getElementById("checkout__card-code").value.replaceAll(/\D/g,"");document.getElementById("checkout__card-code").value=e.substring(0,3)}function y(){var e=document.getElementById("checkout__zip").value.replaceAll(/\D/g,"");document.getElementById("checkout__zip").value=e}function v(){var e=!0;return u.forEach(t=>{e=i(t,!0)?e:!1}),e}function k(){u.forEach(e=>{document.getElementById("checkout__"+e).value="",document.getElementById("checkout__"+e+"-error").style.display="none"})}function f(e){return e}class I{constructor(){this.calculateCost(),this.cleanCart()}cleanCart(){this.checkoutCart=[],this.cart.forEach(t=>{this.checkoutCart.push({id:t.Id,name:t.Name,price:t.FinalPrice,quantity:t.Quantity})})}submitPayment(){if(v()==!0){let t=`{ 
        orderDate: '${new Date().toISOString()}',
        fname: "${document.getElementById("checkout__fname").value}",
        lname: "${document.getElementById("checkout__lname").value}",
        street: "${document.getElementById("checkout__street").value}",
        city: "${document.getElementById("checkout__city").value}",
        state: "${document.getElementById("checkout__state").value}",
        zip: "${document.getElementById("checkout__zip").value}",
        cardNumber: "${document.getElementById("checkout__card-number").value.replace(" ","")}",
        expiration: "${f(document.getElementById("checkout__card-expiration").value)}",
        code: "${document.getElementById("checkout__card-code").value}",
        items: ${JSON.stringify(this.checkoutCart,null,2)},
        orderTotal: "${this.total.toFixed(2)}",
        shipping: ${this.shipping},
        tax: "${this.tax.toFixed(2)}"
      }`;const n={method:"POST",headers:{"Content-Type":"application/json"},body:t},c="http://157.201.228.93:2992/checkout";this.serverResponse=fetch(c,n),document.getElementsByTagName("h2")[0].innerHTML=this.serverResponse}}calculateCost(){this.cart=d("so-cart"),this.itemCount=0,this.subTotal=0,this.shipping=8,this.cart.forEach(n=>{this.itemCount+=n.Quantity,this.subTotal+=n.FinalPrice*n.Quantity,this.shipping+=2*n.Quantity}),this.tax=this.subTotal*.06,this.total=this.subTotal+this.shipping+this.tax;let t=document.getElementById("checkout-form");t.innerHTML=t.innerHTML.multiReplace([["$ITEM_COUNT$",this.itemCount],["$SUBTOTAL$",this.subTotal.toFixed(2)],["$SHIPPING$",this.shipping.toFixed(2)],["$TAX$",this.tax.toFixed(2)],["$TOTAL$",this.total.toFixed(2)]])}}s();let l=new I;document.getElementById("checkout__zip").addEventListener("input",y),document.getElementById("checkout__phone").addEventListener("input",g),document.getElementById("checkout__card-number").addEventListener("input",p),document.getElementById("checkout__card-code").addEventListener("input",E),document.getElementById("checkout-button").addEventListener("click",l.submitPayment.bind(l)),document.getElementById("reset-button").addEventListener("click",k),u.forEach(e=>{document.getElementById("checkout__"+e).addEventListener("blur",()=>{i(e)})});
